// A) My newest Match_Member link (ID↔ID compare)
Set(
    varMyLastLink,
    If(
        !IsBlank(varMe),
        First(
            Sort(
                Filter(
                    Match_Member,
                    'Participant_Email'.'Participant' = varMe.'Participant'   // compare GUID to GUID
                ),
                'Created On',
                SortOrder.Descending
            )
        )
    )
);

// B) The Match of that link
Set(varMatchRef, If(!IsBlank(varMyLastLink), varMyLastLink.Match));

// C) The other person’s link in the same match (duo => exactly one)
Set(
    varPartnerLink,
    If(
        !IsBlank(varMatchRef),
        LookUp(
            Match_Member,
            Match = varMatchRef &&
            'Participant_Email'.'Participant' <> varMe.'Participant'       // not me
        )
    )
);

// D) Materialize the Participant record for safe field access
Set(
    varPartner,
    If(!IsBlank(varPartnerLink), varPartnerLink.'Participant_Email')
);

// E) Final shaped object
Set(
    varLatestMatch,
    If(
        IsBlank(varMyLastLink),
        Blank(),
        {
            MatchID: varMatchRef.'ID (Primary)',
            Match: varMatchRef,
            MyLink: varMyLastLink,
            PartnerLink: varPartnerLink,
            Partner: varPartner  // -> .Location, .Participant_Name, .Participant_Email (Primary)
        }
    )
);
